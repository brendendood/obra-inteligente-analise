# ğŸ“Š CI Pipeline - Inventory Generation
# 
# Pipeline NÃƒO BLOQUEANTE para geraÃ§Ã£o automÃ¡tica de inventÃ¡rios
# Gera artefatos informativos sem impactar desenvolvimento

name: Inventory Generation
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    # Roda diariamente Ã s 6h UTC (3h BRT)
    - cron: '0 6 * * *'

jobs:
  generate-inventory:
    name: ğŸ“‹ Generate Project Inventory
    runs-on: ubuntu-latest
    continue-on-error: true  # NÃƒO BLOQUEIA outros workflows
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ”§ Install Dependencies
      run: npm ci
      continue-on-error: true
      
    - name: ğŸ“‹ Generate File Inventory
      run: |
        echo "ğŸ” Gerando inventÃ¡rio de arquivos..."
        mkdir -p .ci/artifacts
        
        # InventÃ¡rio geral de arquivos
        find src -type f -name "*.ts" -o -name "*.tsx" | \
          head -100 > .ci/artifacts/typescript-files.txt
        
        find src -type f -name "*.json" | \
          head -50 > .ci/artifacts/config-files.txt
          
        # EstatÃ­sticas bÃ¡sicas
        echo "ğŸ“Š ESTATÃSTICAS DO PROJETO - $(date)" > .ci/artifacts/project-stats.txt
        echo "=================================" >> .ci/artifacts/project-stats.txt
        echo "TypeScript files: $(find src -name "*.ts" -o -name "*.tsx" | wc -l)" >> .ci/artifacts/project-stats.txt
        echo "Components: $(find src/components -name "*.tsx" | wc -l)" >> .ci/artifacts/project-stats.txt
        echo "Hooks: $(find src/hooks -name "*.ts" | wc -l)" >> .ci/artifacts/project-stats.txt
        echo "Pages: $(find src/pages -name "*.tsx" | wc -l)" >> .ci/artifacts/project-stats.txt
        echo "Utils: $(find src/utils -name "*.ts" | wc -l)" >> .ci/artifacts/project-stats.txt
        
    - name: ğŸ¯ Generate Dependency Analysis
      run: |
        echo "ğŸ“¦ Analisando dependÃªncias..."
        
        # AnÃ¡lise de package.json
        if [ -f package.json ]; then
          echo "ğŸ“‹ DEPENDÃŠNCIAS - $(date)" > .ci/artifacts/dependencies.txt
          echo "========================" >> .ci/artifacts/dependencies.txt
          echo "Production deps:" >> .ci/artifacts/dependencies.txt
          jq -r '.dependencies | keys[]?' package.json | wc -l >> .ci/artifacts/dependencies.txt
          echo "Dev deps:" >> .ci/artifacts/dependencies.txt
          jq -r '.devDependencies | keys[]?' package.json | wc -l >> .ci/artifacts/dependencies.txt
        fi
        
    - name: ğŸ” Generate Import Analysis
      run: |
        echo "ğŸ”— Analisando imports..."
        
        # Imports mais frequentes
        grep -r "import.*from" src/ | \
          sed "s/.*import.*from ['\"]\\([^'\"]*\\)['\"].*/\\1/" | \
          sort | uniq -c | sort -nr | \
          head -20 > .ci/artifacts/top-imports.txt
          
        # Imports de utils (para anÃ¡lise de migraÃ§Ã£o)
        grep -r "import.*@/utils" src/ | \
          wc -l > .ci/artifacts/utils-imports-count.txt
          
    - name: ğŸ“„ Generate Documentation Index
      run: |
        echo "ğŸ“š Indexando documentaÃ§Ã£o..."
        
        echo "ğŸ“– ÃNDICE DE DOCUMENTAÃ‡ÃƒO - $(date)" > .ci/artifacts/docs-index.txt
        echo "===================================" >> .ci/artifacts/docs-index.txt
        
        find docs -name "*.md" | sort >> .ci/artifacts/docs-index.txt
        echo "" >> .ci/artifacts/docs-index.txt
        echo "Total docs: $(find docs -name "*.md" | wc -l)" >> .ci/artifacts/docs-index.txt
        
    - name: ğŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: inventory-artifacts
        path: .ci/artifacts/
        retention-days: 30
        
    - name: ğŸ“ Log Summary
      if: always()
      run: |
        echo "âœ… InventÃ¡rio gerado com sucesso!"
        echo "ğŸ“Š Artefatos disponÃ­veis em Actions > Artifacts"
        echo "ğŸ”„ PrÃ³xima execuÃ§Ã£o: daily @ 6h UTC"