# ðŸ”— Entity Relationship Diagram - MadenAI

**Generated on:** 2025-08-25  
**Database:** PostgreSQL (Supabase)  
**Project ID:** mozqijzvtbuwuzgemzsm  

---

## ERD Overview

This document describes the entity relationships in the MadenAI database schema. Due to the complexity of the system (35+ tables), the ERD is organized into logical domains.

---

## Domain Architecture

```mermaid
graph TB
    subgraph "Core Domain"
        USERS[User Management]
        PROJECTS[Project Management] 
        AI[AI & Communication]
    end
    
    subgraph "Business Domain"
        CRM[CRM & Clients]
        PAYMENTS[Billing & Payments]
        GAMIF[Gamification]
    end
    
    subgraph "Platform Domain"
        ADMIN[Admin & Security]
        ANALYTICS[Analytics & Tracking]
        SYSTEM[System & Config]
    end
    
    USERS --> PROJECTS
    USERS --> AI
    USERS --> CRM
    USERS --> PAYMENTS
    USERS --> GAMIF
    USERS --> ANALYTICS
    
    PROJECTS --> AI
    PROJECTS --> CRM
    
    ADMIN --> USERS
    ADMIN --> PROJECTS
    ADMIN --> SYSTEM
```

---

## Core Domain ERD

### User Management Core

```mermaid
erDiagram
    auth_users ||--o{ user_profiles : "extends"
    user_profiles ||--o{ user_subscriptions : "has"
    user_profiles ||--o{ user_plans : "has"
    user_profiles ||--o{ user_payments : "has"
    user_profiles ||--o{ user_referrals : "referred_by"
    user_profiles ||--o{ user_referrals : "referrer"
    user_profiles ||--o{ user_gamification : "tracks"
    user_profiles ||--o{ user_login_history : "logs"
    
    auth_users {
        uuid id PK
        text email
        text phone
        jsonb raw_user_meta_data
        timestamptz created_at
        timestamptz last_sign_in_at
    }
    
    user_profiles {
        uuid id PK
        uuid user_id FK
        text full_name
        text company
        text phone
        text city
        text state
        text country
        text avatar_url
        text gender
        text ref_code
        text referred_by
        integer credits
        text[] tags
        timestamptz created_at
        timestamptz updated_at
    }
    
    user_subscriptions {
        uuid id PK
        uuid user_id FK
        subscription_plan plan
        subscription_status status
        timestamptz created_at
        timestamptz updated_at
    }
    
    user_plans {
        uuid user_id PK
        plan_tier_v2 plan_tier
        integer messages_quota
        integer seats
        billing_cycle billing_cycle
        timestamptz created_at
        timestamptz updated_at
    }
    
    user_referrals {
        uuid id PK
        uuid referrer_user_id FK
        uuid referred_user_id FK
        text referral_code
        boolean credits_awarded
        timestamptz created_at
    }
```

### Project Management Core

```mermaid
erDiagram
    user_profiles ||--o{ projects : "owns"
    projects ||--o{ project_budget_items : "contains"
    projects ||--o{ project_schedule_tasks : "contains"
    projects ||--o{ project_documents : "contains"
    projects ||--o{ project_conversations : "contains"
    projects ||--o{ project_analyses : "contains"
    project_schedule_tasks ||--o{ project_schedule_tasks : "depends_on"
    
    projects {
        uuid id PK
        uuid user_id FK
        text name
        text description
        text file_path
        bigint file_size
        text pdf_url
        text extracted_text
        jsonb analysis_data
        text project_type
        text project_status
        numeric total_area
        numeric estimated_budget
        date start_date
        date end_date
        text city
        text state
        text country
        timestamptz created_at
        timestamptz updated_at
    }
    
    project_budget_items {
        uuid id PK
        uuid project_id FK
        text description
        text category
        text environment
        text unit
        numeric quantity
        numeric unit_value
        numeric subtotal
        text sinapi_code
        integer sort_order
        timestamptz created_at
        timestamptz updated_at
    }
    
    project_schedule_tasks {
        uuid id PK
        uuid project_id FK
        uuid dependency_id FK
        text stage_name
        integer stage_number
        text status
        date start_date
        date end_date
        integer duration_days
        text category
        timestamptz created_at
        timestamptz updated_at
    }
    
    project_documents {
        uuid id PK
        uuid project_id FK
        uuid user_id FK
        text file_name
        text file_type
        text mime_type
        text category
        text file_path
        bigint file_size
        timestamptz uploaded_at
        timestamptz updated_at
    }
```

---

## AI & Communication Domain ERD

```mermaid
erDiagram
    user_profiles ||--o{ ai_conversations : "owns"
    projects ||--o{ ai_conversations : "relates_to"
    ai_conversations ||--o{ ai_messages : "contains"
    user_profiles ||--o{ ai_message_usage : "tracks"
    user_profiles ||--o{ ai_usage_metrics : "tracks"
    user_profiles ||--o{ n8n_chat_histories : "owns"
    
    ai_conversations {
        uuid id PK
        uuid user_id FK
        uuid project_id FK
        text title
        text assistant_id
        text thread_id
        text status
        timestamptz created_at
        timestamptz updated_at
    }
    
    ai_messages {
        uuid id PK
        uuid conversation_id FK
        uuid user_id FK
        text role
        text content
        text message_id
        text run_id
        jsonb metadata
        integer rating
        text feedback
        timestamptz created_at
    }
    
    ai_message_usage {
        bigint id PK
        uuid user_id FK
        character period_ym
        integer count
        timestamptz created_at
        timestamptz updated_at
    }
    
    ai_usage_metrics {
        uuid id PK
        uuid user_id FK
        uuid project_id FK
        text feature_type
        integer tokens_used
        numeric cost_usd
        integer response_rating
        text feedback_text
        timestamptz created_at
    }
    
    n8n_chat_histories {
        integer id PK
        uuid user_id FK
        varchar session_id
        jsonb message
    }
```

---

## CRM & Business Domain ERD

```mermaid
erDiagram
    user_profiles ||--o{ crm_clients : "owns"
    crm_clients ||--o{ crm_projects : "has"
    user_profiles ||--o{ crm_projects : "owns"
    user_profiles ||--o{ coupons : "owns"
    user_profiles ||--o{ payments : "makes"
    
    crm_clients {
        uuid id PK
        uuid owner_id FK
        text name
        text email
        text phone
        text company
        text status
        text avatar
        timestamptz created_at
        timestamptz updated_at
    }
    
    crm_projects {
        uuid id PK
        uuid owner_id FK
        uuid client_id FK
        text name
        text description
        numeric value
        text status
        date start_date
        date end_date
        timestamptz created_at
        timestamptz updated_at
    }
    
    payments {
        uuid id PK
        uuid user_id FK
        uuid subscription_id FK
        numeric amount
        text currency
        text status
        text payment_method
        text stripe_payment_intent_id
        text invoice_url
        timestamptz created_at
    }
    
    coupons {
        uuid id PK
        uuid user_id FK
        text code
        text discount_type
        numeric discount_value
        integer max_uses
        integer current_uses
        boolean active
        timestamptz valid_from
        timestamptz valid_until
        timestamptz created_at
    }
```

---

## Gamification Domain ERD

```mermaid
erDiagram
    user_profiles ||--o{ user_gamification : "has"
    achievements ||--o{ user_gamification : "earned_by"
    user_profiles ||--o{ gamification_logs : "generates"
    
    achievements {
        uuid id PK
        text code
        text name
        text description
        text icon
        integer points_required
        integer action_count_required
        text action_type
        boolean is_active
        timestamptz created_at
    }
    
    user_gamification {
        uuid id PK
        uuid user_id FK
        integer total_points
        integer current_level
        integer current_level_points
        integer daily_streak
        jsonb achievements
        date last_login_date
        date last_action_date
        timestamptz created_at
        timestamptz updated_at
    }
    
    gamification_logs {
        uuid id PK
        uuid user_id FK
        text action_type
        integer points_awarded
        jsonb details
        timestamptz created_at
    }
```

---

## Admin & Security Domain ERD

```mermaid
erDiagram
    admin_users ||--o{ admin_permissions : "has"
    admin_users ||--o{ admin_audit_logs : "performs"
    admin_users ||--o{ admin_security_logs : "generates"
    admin_users ||--o{ admin_impersonation_logs : "initiates"
    user_profiles ||--o{ admin_impersonation_logs : "target"
    
    admin_users {
        uuid id PK
        text email
        text full_name
        boolean is_active
        timestamptz last_login
        timestamptz created_at
    }
    
    admin_permissions {
        uuid id PK
        uuid user_id FK
        admin_role role
        boolean active
        uuid granted_by FK
        timestamptz granted_at
    }
    
    admin_audit_logs {
        uuid id PK
        uuid admin_user_id FK
        text action_type
        text target_type
        uuid target_id
        jsonb old_values
        jsonb new_values
        inet ip_address
        text user_agent
        timestamptz created_at
    }
    
    admin_security_logs {
        uuid id PK
        uuid admin_id FK
        text action_type
        uuid target_user_id FK
        jsonb details
        boolean success
        inet ip_address
        text user_agent
        timestamptz created_at
    }
    
    admin_impersonation_logs {
        uuid id PK
        uuid admin_id FK
        uuid user_impersonated_id FK
        text reason
        integer duration_minutes
        inet ip_address
        text user_agent
        timestamptz started_at
        timestamptz ended_at
        timestamptz created_at
    }
```

---

## Analytics & Tracking Domain ERD

```mermaid
erDiagram
    user_profiles ||--o{ user_analytics : "generates"
    user_profiles ||--o{ user_analytics_enhanced : "generates"
    user_profiles ||--o{ user_login_history : "creates"
    user_profiles ||--o{ email_logs : "receives"
    email_templates ||--o{ email_logs : "used_in"
    user_profiles ||--o{ chat_access_logs : "accesses"
    
    user_analytics {
        uuid id PK
        uuid user_id FK
        text session_id
        event_type event_type
        text page_url
        text user_agent
        inet ip_address
        jsonb event_data
        jsonb events
        integer session_duration
        timestamptz last_active
        timestamptz created_at
    }
    
    user_analytics_enhanced {
        uuid id PK
        uuid user_id FK
        text session_id
        text event_type
        text page_url
        text referrer
        text utm_source
        text utm_medium
        text utm_campaign
        jsonb event_data
        inet ip_address
        text user_agent
        timestamptz created_at
    }
    
    user_login_history {
        uuid id PK
        uuid user_id FK
        inet ip_address
        text user_agent
        text device_type
        text browser
        text os
        text city
        text region
        text country
        numeric latitude
        numeric longitude
        integer session_duration
        timestamptz login_at
        timestamptz created_at
    }
    
    email_logs {
        uuid id PK
        uuid user_id FK
        text template_key FK
        text email_type
        text recipient_email
        text subject
        text status
        text template_version
        jsonb metadata
        timestamptz sent_at
        timestamptz created_at
    }
    
    email_templates {
        uuid id PK
        text template_key
        text category
        text subject
        text html
        text description
        text locale
        text from_name
        text from_email
        text reply_to
        boolean enabled
        uuid updated_by FK
        timestamptz created_at
        timestamptz updated_at
    }
```

---

## System & Configuration Domain ERD

```mermaid
erDiagram
    alert_configurations ||--o{ alert_logs : "triggers"
    kv_store_40b370d9 ||--o{ kv_store_40b370d9 : "references"
    
    alert_configurations {
        uuid id PK
        text name
        text alert_type
        text description
        jsonb conditions
        jsonb actions
        boolean enabled
        timestamptz created_at
        timestamptz updated_at
    }
    
    alert_logs {
        uuid id PK
        uuid project_id FK
        uuid user_id FK
        text alert_type
        text severity
        text message
        jsonb metadata
        boolean resolved
        timestamptz triggered_at
    }
    
    kv_store_40b370d9 {
        text key PK
        jsonb value
    }
    
    chat_access_logs {
        uuid id PK
        uuid user_id FK
        text session_id
        text access_type
        inet ip_address
        text user_agent
        timestamptz created_at
    }
```

---

## Cross-Domain Relationships

### Major Integration Points

1. **User â†’ Everything**: All user-scoped data links to `user_profiles`
2. **Projects â†’ AI**: Projects can have AI conversations and analyses
3. **Projects â†’ CRM**: Projects sync to CRM system automatically
4. **Analytics â†’ All**: User actions tracked across all domains
5. **Admin â†’ Management**: Admin can audit and manage all user data

### Key Foreign Key Relationships

```sql
-- Core relationships
user_profiles.user_id â†’ auth.users.id (logical, not enforced)
projects.user_id â†’ user_profiles.user_id (enforced via RLS)

-- Project relationships
project_budget_items.project_id â†’ projects.id
project_schedule_tasks.project_id â†’ projects.id
project_documents.project_id â†’ projects.id

-- AI relationships
ai_conversations.user_id â†’ user_profiles.user_id
ai_conversations.project_id â†’ projects.id
ai_messages.conversation_id â†’ ai_conversations.id

-- CRM relationships
crm_clients.owner_id â†’ user_profiles.user_id
crm_projects.owner_id â†’ user_profiles.user_id
crm_projects.client_id â†’ crm_clients.id

-- Admin relationships (enforced via RLS)
admin_audit_logs.admin_user_id â†’ admin_users.id
admin_impersonation_logs.admin_id â†’ admin_users.id
admin_impersonation_logs.user_impersonated_id â†’ user_profiles.user_id
```

---

## Data Flow Patterns

### 1. User Signup Flow
```
auth.users (Supabase Auth)
    â†“ trigger: on_auth_user_created
user_profiles (via handle_new_user_profile())
    â†“ automatic
user_subscriptions (free plan)
    â†“ if referral
user_referrals (credit system)
    â†“ gamification
user_gamification (initial points)
```

### 2. Project Creation Flow
```
projects (user uploads)
    â†“ AI processing
project_analyses (AI results)
    â†“ budget generation
project_budget_items (SINAPI data)
    â†“ schedule generation
project_schedule_tasks (timeline)
    â†“ CRM sync
crm_projects (business tracking)
```

### 3. AI Interaction Flow
```
ai_conversations (session start)
    â†“ user messages
ai_messages (user input)
    â†“ N8N webhook
n8n_chat_histories (processing)
    â†“ AI response
ai_messages (assistant response)
    â†“ usage tracking
ai_message_usage (quota management)
    â†“ metrics
ai_usage_metrics (analytics)
```

---

## Cardinality Rules

### One-to-One (1:1)
- `user_profiles` : `user_plans` (each user has one plan)
- `user_profiles` : `user_gamification` (each user has one gamification record)

### One-to-Many (1:N)
- `user_profiles` : `projects` (user owns many projects)
- `projects` : `project_budget_items` (project has many budget items)
- `ai_conversations` : `ai_messages` (conversation has many messages)
- `crm_clients` : `crm_projects` (client has many projects)

### Many-to-Many (M:N)
- `user_profiles` : `achievements` (via `user_gamification.achievements` jsonb)
- `projects` : `ai_conversations` (projects can have multiple AI sessions)

---

## Indexing Strategy

### Primary Indexes (Automatic)
- All tables have UUID primary keys with B-tree indexes

### Foreign Key Indexes (Required)
```sql
-- User relationships
CREATE INDEX idx_projects_user_id ON projects(user_id);
CREATE INDEX idx_ai_conversations_user_id ON ai_conversations(user_id);
CREATE INDEX idx_crm_clients_owner_id ON crm_clients(owner_id);

-- Project relationships
CREATE INDEX idx_budget_items_project_id ON project_budget_items(project_id);
CREATE INDEX idx_schedule_tasks_project_id ON project_schedule_tasks(project_id);
CREATE INDEX idx_ai_conversations_project_id ON ai_conversations(project_id);

-- AI relationships
CREATE INDEX idx_ai_messages_conversation_id ON ai_messages(conversation_id);
```

### Composite Indexes (Performance)
```sql
-- Common query patterns
CREATE INDEX idx_projects_user_status ON projects(user_id, project_status);
CREATE INDEX idx_ai_messages_conversation_created ON ai_messages(conversation_id, created_at);
CREATE INDEX idx_budget_items_project_category ON project_budget_items(project_id, category);
```

---

## Data Integrity Rules

### Referential Integrity
- Enforced via PostgreSQL foreign keys where appropriate
- Supabase auth tables not directly referenced (RLS handles access)
- Cascade deletes for dependent data (budget items, messages, etc.)

### Business Rules
- Users can only access their own data (enforced via RLS)
- Projects must have valid user owners
- AI conversations must belong to valid users
- Admin actions must be performed by authorized admins

### Data Validation
- UUID generation for all primary keys
- Timestamp automation via triggers
- Enum constraints for status fields
- Check constraints for positive values (quantities, prices)

---

## Security (RLS) Patterns

### User Data Isolation
```sql
-- Pattern: Users see only their data
CREATE POLICY "users_own_data" ON table_name 
FOR ALL USING (auth.uid() = user_id);
```

### Project-Based Access
```sql
-- Pattern: Access through project ownership
CREATE POLICY "project_access" ON table_name 
FOR ALL USING (
  EXISTS (
    SELECT 1 FROM projects 
    WHERE projects.id = table_name.project_id 
    AND projects.user_id = auth.uid()
  )
);
```

### Admin Override
```sql
-- Pattern: Admins can access everything
CREATE POLICY "admin_access" ON table_name 
FOR ALL USING (is_admin_user());
```

---

## Performance Considerations

### Large Tables (>10K records)
- `ai_messages` - Partition by conversation_id
- `user_analytics_enhanced` - Partition by date
- `project_budget_items` - Index on project_id + category
- `user_login_history` - Archive old records

### Query Optimization
- Use covering indexes for common SELECT patterns
- Avoid N+1 queries with proper JOINs
- Implement pagination for large result sets
- Use JSONB indexes for metadata searches

### Scaling Strategies
- Read replicas for analytics queries
- Table partitioning for time-series data
- Archival strategies for audit logs
- Connection pooling for high concurrency

---

## Maintenance Tasks

### Daily
- Monitor index usage and performance
- Check for long-running queries
- Validate referential integrity

### Weekly
- Analyze table growth patterns
- Review slow query logs
- Update table statistics

### Monthly
- Archive old analytics data
- Rebuild fragmented indexes
- Review and optimize RLS policies

---

## Change Impact Analysis

When modifying this ERD:

1. **Adding Tables**: Ensure proper RLS policies and indexes
2. **Adding Relationships**: Update foreign key constraints and indexes
3. **Removing Tables**: Check for dependencies and cascade effects
4. **Modifying Columns**: Update application code and type definitions

---

**ERD Version:** 1.0  
**Last Updated:** 2025-08-25  
**Total Tables:** 35  
**Total Relationships:** 50+  
**Next Review:** 2025-09-25