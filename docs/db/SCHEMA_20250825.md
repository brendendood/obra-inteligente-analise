# ðŸ—„ï¸ Database Schema Documentation - MadenAI

**Generated on:** 2025-08-25  
**Database:** PostgreSQL (Supabase)  
**Project ID:** mozqijzvtbuwuzgemzsm  

---

## Overview

This document describes the complete database schema for the MadenAI platform, including all tables, columns, data types, constraints, indexes, and relationships.

---

## Table Summary

| Table | Purpose | Record Count Est. | Primary Features |
|-------|---------|------------------|------------------|
| `achievements` | Gamification system achievements | ~50 | Icon, points, actions |
| `admin_audit_logs` | Admin action logging | ~1000 | Audit trail, JSON values |
| `admin_impersonation_logs` | Admin impersonation tracking | ~100 | Session duration, IP tracking |
| `admin_permissions` | Admin role management | ~10 | Role-based access control |
| `admin_security_logs` | Security action logging | ~500 | IP, user agent, success/failure |
| `admin_users` | Admin user management | ~5 | Active status, login tracking |
| `ai_conversations` | AI chat conversations | ~10000 | Project-linked, thread management |
| `ai_message_usage` | AI usage quotas tracking | ~5000 | Monthly periods, usage counts |
| `ai_messages` | Individual AI messages | ~50000 | Content, role, feedback, metadata |
| `ai_usage_metrics` | AI cost and performance metrics | ~20000 | Tokens, cost, ratings |
| `alert_configurations` | System alert configurations | ~20 | Conditions, actions, webhooks |
| `alert_logs` | Triggered alert history | ~1000 | Severity, resolution status |
| `chat_access_logs` | Chat access tracking | ~5000 | Session tracking, IP logging |
| `coupons` | Discount coupons system | ~100 | Validity, usage limits |
| `crm_clients` | CRM client management | ~5000 | Contact info, status tracking |
| `crm_projects` | CRM project management | ~10000 | Client-linked, value tracking |
| `email_logs` | Email delivery tracking | ~50000 | Templates, status, metadata |
| `email_templates` | Email template management | ~50 | Localization, versioning |
| `gamification_logs` | Gamification action logs | ~25000 | Points, achievements tracking |
| `kv_store_40b370d9` | Key-value storage | ~1000 | JSON values, configuration |
| `n8n_chat_histories` | N8N chat integration | ~10000 | Session-based messaging |
| `payments` | Payment processing | ~1000 | Stripe integration, invoices |
| `project_analyses` | AI project analysis results | ~5000 | JSON results, type tracking |
| `project_budget_items` | Project budget line items | ~100000 | SINAPI codes, calculations |
| `project_conversations` | Project-specific chats | ~20000 | Sender, message tracking |
| `project_documents` | Document management | ~25000 | File storage, categorization |
| `project_schedule_tasks` | Project timeline tasks | ~50000 | Dependencies, status tracking |
| `projects` | Main project records | ~15000 | File processing, analysis data |
| `safe_admin_users` | Safe admin user view | ~5 | Read-only admin data |
| `user_analytics` | User behavior analytics | ~100000 | Events, sessions, page tracking |
| `user_analytics_enhanced` | Enhanced analytics | ~150000 | UTM tracking, referrers |
| `user_gamification` | User gamification data | ~5000 | Points, levels, streaks |
| `user_login_history` | Login tracking | ~25000 | IP geolocation, device info |
| `user_payments` | User payment history | ~1000 | Stripe customer data |
| `user_plans` | User subscription plans | ~5000 | Quotas, billing cycles |
| `user_profiles` | User profile information | ~5000 | Personal data, preferences |
| `user_referrals` | Referral system tracking | ~1000 | Credit rewards, tracking |
| `user_subscriptions` | Subscription management | ~5000 | Plan status, billing |

---

## Detailed Table Definitions

### Core Tables

#### `projects`
**Purpose:** Main project management table storing construction projects and their analysis data.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | uuid | No | gen_random_uuid() | Primary key |
| `user_id` | uuid | No | - | Owner of the project |
| `name` | text | No | - | Project name |
| `description` | text | Yes | - | Project description |
| `file_path` | text | No | - | Uploaded file path |
| `file_size` | bigint | Yes | - | File size in bytes |
| `pdf_url` | text | Yes | - | Processed PDF URL |
| `pdf_checksum` | text | Yes | - | File integrity check |
| `extracted_text` | text | Yes | - | OCR extracted text |
| `analysis_data` | jsonb | Yes | - | AI analysis results |
| `project_type` | text | Yes | - | Type of construction |
| `project_status` | text | Yes | 'draft' | Current status |
| `total_area` | numeric | Yes | - | Total area in mÂ² |
| `estimated_budget` | numeric | Yes | - | Estimated cost |
| `start_date` | date | Yes | - | Project start date |
| `end_date` | date | Yes | - | Project end date |
| `city` | text | Yes | - | Project location |
| `state` | text | Yes | - | State/province |
| `country` | text | Yes | 'Brasil' | Country |
| `created_at` | timestamptz | No | now() | Creation timestamp |
| `updated_at` | timestamptz | No | now() | Last update |

**Indexes:**
- PRIMARY KEY: `id`
- INDEX: `user_id` (for user queries)
- INDEX: `created_at` (for sorting)
- INDEX: `project_status` (for filtering)

**Triggers:**
- `sync_project_to_crm` - Syncs to CRM on insert
- `trigger_project_completion_email` - Email on completion

#### `user_profiles`
**Purpose:** Extended user information beyond Supabase auth.users.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | uuid | No | gen_random_uuid() | Primary key |
| `user_id` | uuid | Yes | - | Reference to auth.users |
| `full_name` | text | Yes | - | Full display name |
| `company` | text | Yes | - | Company name |
| `phone` | text | Yes | - | Phone number |
| `city` | text | Yes | - | User's city |
| `state` | text | Yes | - | User's state |
| `country` | text | Yes | 'Brasil' | User's country |
| `avatar_url` | text | Yes | - | Profile picture URL |
| `avatar_type` | text | Yes | 'initials' | Avatar type |
| `gender` | text | Yes | 'male' | Gender preference |
| `cargo` | text | Yes | - | Job title |
| `empresa` | text | Yes | - | Company (alternative) |
| `bio` | text | Yes | - | User bio |
| `timezone` | text | Yes | - | User timezone |
| `ref_code` | text | Yes | - | Referral code |
| `referred_by` | text | Yes | - | Referrer code |
| `credits` | integer | Yes | 0 | Available credits |
| `tags` | text[] | Yes | {} | User tags |
| `created_at` | timestamptz | Yes | now() | Creation timestamp |
| `updated_at` | timestamptz | Yes | now() | Last update |

**Triggers:**
- `sync_user_metadata` - Syncs to auth.users metadata
- `handle_new_user_profile` - Auto-creation on signup

### Project Management Tables

#### `project_budget_items`
**Purpose:** Detailed budget breakdown for construction projects.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | uuid | No | gen_random_uuid() | Primary key |
| `project_id` | uuid | No | - | Parent project |
| `description` | text | Yes | - | Item description |
| `category` | text | Yes | - | Budget category |
| `environment` | text | Yes | - | Environment/room |
| `topic` | text | Yes | - | Topic classification |
| `unit` | text | Yes | - | Unit of measurement |
| `quantity` | numeric | No | 0 | Quantity |
| `unit_value` | numeric | No | 0 | Price per unit |
| `subtotal` | numeric | Yes | - | Calculated subtotal |
| `sinapi_code` | text | Yes | - | SINAPI reference code |
| `source` | text | Yes | - | Data source |
| `sort_order` | integer | Yes | - | Display order |
| `created_at` | timestamptz | No | now() | Creation timestamp |
| `updated_at` | timestamptz | No | now() | Last update |

**Indexes:**
- PRIMARY KEY: `id`
- INDEX: `project_id` (for project queries)
- INDEX: `category` (for filtering)
- INDEX: `sort_order` (for ordering)

#### `project_schedule_tasks`
**Purpose:** Project timeline and task management.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | uuid | No | gen_random_uuid() | Primary key |
| `project_id` | uuid | No | - | Parent project |
| `stage_name` | text | No | - | Task/stage name |
| `stage_number` | integer | Yes | - | Sequence number |
| `status` | text | Yes | 'planejado' | Task status |
| `start_date` | date | Yes | - | Planned start |
| `end_date` | date | Yes | - | Planned end |
| `duration_days` | integer | Yes | - | Duration in days |
| `dependency_id` | uuid | Yes | - | Dependent task |
| `category` | text | Yes | - | Task category |
| `source` | text | Yes | - | Data source |
| `created_at` | timestamptz | No | now() | Creation timestamp |
| `updated_at` | timestamptz | No | now() | Last update |

**Indexes:**
- PRIMARY KEY: `id`
- INDEX: `project_id` (for project queries)
- INDEX: `start_date` (for timeline)
- INDEX: `dependency_id` (for dependencies)

### AI and Communication Tables

#### `ai_conversations`
**Purpose:** AI chat conversation management.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | uuid | No | gen_random_uuid() | Primary key |
| `user_id` | uuid | No | - | Conversation owner |
| `project_id` | uuid | Yes | - | Related project |
| `title` | text | No | 'Nova Conversa' | Conversation title |
| `assistant_id` | text | Yes | - | AI assistant ID |
| `thread_id` | text | Yes | - | External thread ID |
| `status` | text | No | 'active' | Conversation status |
| `created_at` | timestamptz | No | now() | Creation timestamp |
| `updated_at` | timestamptz | No | now() | Last update |

**Triggers:**
- `update_ai_conversations_updated_at` - Auto-update timestamp

#### `ai_messages`
**Purpose:** Individual messages within AI conversations.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | uuid | No | gen_random_uuid() | Primary key |
| `conversation_id` | uuid | No | - | Parent conversation |
| `user_id` | uuid | No | - | Message sender |
| `role` | text | No | - | Message role (user/assistant) |
| `content` | text | No | - | Message content |
| `message_id` | text | Yes | - | External message ID |
| `run_id` | text | Yes | - | Execution run ID |
| `metadata` | jsonb | Yes | {} | Additional metadata |
| `rating` | integer | Yes | - | User rating (1-5) |
| `feedback` | text | Yes | - | User feedback |
| `created_at` | timestamptz | No | now() | Creation timestamp |

**Indexes:**
- PRIMARY KEY: `id`
- INDEX: `conversation_id` (for conversation queries)
- INDEX: `user_id` (for user queries)
- INDEX: `created_at` (for ordering)

### CRM Tables

#### `crm_clients`
**Purpose:** Customer relationship management for clients.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | uuid | No | gen_random_uuid() | Primary key |
| `owner_id` | uuid | No | - | CRM owner |
| `name` | text | No | - | Client name |
| `email` | text | Yes | - | Client email |
| `phone` | text | Yes | - | Client phone |
| `company` | text | Yes | - | Client company |
| `status` | text | No | 'prospect' | Client status |
| `avatar` | text | Yes | - | Client avatar |
| `created_at` | timestamptz | No | now() | Creation timestamp |
| `updated_at` | timestamptz | No | now() | Last update |

#### `crm_projects`
**Purpose:** CRM project management linked to clients.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | uuid | No | gen_random_uuid() | Primary key |
| `owner_id` | uuid | No | - | Project owner |
| `client_id` | uuid | No | - | Related client |
| `name` | text | No | - | Project name |
| `description` | text | Yes | - | Project description |
| `value` | numeric | No | 0 | Project value |
| `status` | text | No | 'planning' | Project status |
| `start_date` | date | No | - | Start date |
| `end_date` | date | Yes | - | End date |
| `created_at` | timestamptz | No | now() | Creation timestamp |
| `updated_at` | timestamptz | No | now() | Last update |

### Admin and Security Tables

#### `admin_permissions`
**Purpose:** Role-based admin access control.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | uuid | No | gen_random_uuid() | Primary key |
| `user_id` | uuid | Yes | - | Admin user |
| `role` | admin_role | No | - | Admin role enum |
| `active` | boolean | Yes | true | Permission active |
| `granted_at` | timestamptz | No | now() | Grant timestamp |
| `granted_by` | uuid | Yes | - | Granting admin |

**Enums:**
- `admin_role`: super_admin, admin, moderator

#### `admin_audit_logs`
**Purpose:** Comprehensive audit trail for admin actions.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | uuid | No | gen_random_uuid() | Primary key |
| `admin_user_id` | uuid | Yes | - | Admin performing action |
| `action_type` | text | No | - | Type of action |
| `target_type` | text | Yes | - | Target object type |
| `target_id` | uuid | Yes | - | Target object ID |
| `old_values` | jsonb | Yes | - | Previous values |
| `new_values` | jsonb | Yes | - | New values |
| `ip_address` | inet | Yes | - | IP address |
| `user_agent` | text | Yes | - | Browser user agent |
| `created_at` | timestamptz | No | now() | Action timestamp |

### Gamification Tables

#### `achievements`
**Purpose:** Available achievements in the gamification system.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | uuid | No | gen_random_uuid() | Primary key |
| `code` | text | No | - | Unique achievement code |
| `name` | text | No | - | Achievement name |
| `description` | text | No | - | Achievement description |
| `icon` | text | No | - | Icon identifier |
| `points_required` | integer | Yes | 0 | Points needed |
| `action_count_required` | integer | Yes | 0 | Action count needed |
| `action_type` | text | Yes | - | Required action type |
| `is_active` | boolean | Yes | true | Achievement available |
| `created_at` | timestamptz | Yes | now() | Creation timestamp |

#### `user_gamification`
**Purpose:** User progress in gamification system.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | uuid | No | gen_random_uuid() | Primary key |
| `user_id` | uuid | No | - | User reference |
| `total_points` | integer | Yes | 0 | Total points earned |
| `current_level` | integer | Yes | 1 | Current level |
| `current_level_points` | integer | Yes | 0 | Points in current level |
| `daily_streak` | integer | Yes | 0 | Consecutive days |
| `achievements` | jsonb | Yes | [] | Earned achievements |
| `last_login_date` | date | Yes | CURRENT_DATE | Last login |
| `last_action_date` | date | Yes | CURRENT_DATE | Last action |
| `created_at` | timestamptz | Yes | now() | Creation timestamp |
| `updated_at` | timestamptz | Yes | now() | Last update |

### Analytics Tables

#### `user_analytics_enhanced`
**Purpose:** Enhanced user behavior analytics with UTM tracking.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | uuid | No | gen_random_uuid() | Primary key |
| `user_id` | uuid | Yes | - | User reference |
| `session_id` | text | Yes | - | Session identifier |
| `event_type` | text | No | - | Event type |
| `page_url` | text | Yes | - | Page URL |
| `referrer` | text | Yes | - | Referrer URL |
| `utm_source` | text | Yes | - | UTM source |
| `utm_medium` | text | Yes | - | UTM medium |
| `utm_campaign` | text | Yes | - | UTM campaign |
| `event_data` | jsonb | Yes | {} | Event metadata |
| `ip_address` | inet | Yes | - | IP address |
| `user_agent` | text | Yes | - | Browser user agent |
| `created_at` | timestamptz | Yes | now() | Event timestamp |

---

## Data Types

### Custom Enums

```sql
-- Admin roles
CREATE TYPE admin_role AS ENUM ('super_admin', 'admin', 'moderator');

-- Billing cycles
CREATE TYPE billing_cycle AS ENUM ('mensal', 'anual');

-- Plan tiers
CREATE TYPE plan_tier_v2 AS ENUM ('FREE', 'BASIC', 'PRO', 'ENTERPRISE');

-- Subscription status
CREATE TYPE subscription_status AS ENUM ('active', 'cancelled', 'past_due', 'trialing');

-- Event types for analytics
CREATE TYPE event_type AS ENUM ('page_view', 'click', 'form_submit', 'user_action');
```

### Standard PostgreSQL Types Used

- `uuid` - Universally unique identifiers (primary keys)
- `text` - Variable-length strings
- `integer` - 32-bit integers
- `bigint` - 64-bit integers
- `numeric` - Arbitrary precision numbers
- `boolean` - True/false values
- `date` - Date values (no time)
- `timestamp with time zone` - Timestamps with timezone
- `jsonb` - Binary JSON (indexed, queryable)
- `inet` - IP addresses (IPv4/IPv6)
- `text[]` - Arrays of text

---

## Indexes

### Primary Indexes (Automatic)
All tables have UUID primary keys with automatic B-tree indexes.

### Secondary Indexes (Performance)

#### High-Traffic Query Indexes
```sql
-- User-based queries
CREATE INDEX idx_projects_user_id ON projects(user_id);
CREATE INDEX idx_ai_conversations_user_id ON ai_conversations(user_id);
CREATE INDEX idx_ai_messages_conversation_id ON ai_messages(conversation_id);

-- Time-based queries
CREATE INDEX idx_projects_created_at ON projects(created_at DESC);
CREATE INDEX idx_ai_messages_created_at ON ai_messages(created_at DESC);
CREATE INDEX idx_user_login_history_login_at ON user_login_history(login_at DESC);

-- Status and filtering
CREATE INDEX idx_projects_status ON projects(project_status);
CREATE INDEX idx_crm_clients_status ON crm_clients(status);
CREATE INDEX idx_alert_logs_resolved ON alert_logs(resolved);

-- Composite indexes for common queries
CREATE INDEX idx_budget_items_project_category ON project_budget_items(project_id, category);
CREATE INDEX idx_schedule_tasks_project_date ON project_schedule_tasks(project_id, start_date);
```

#### JSONB Indexes (Advanced Queries)
```sql
-- Metadata searches
CREATE INDEX idx_ai_messages_metadata ON ai_messages USING GIN(metadata);
CREATE INDEX idx_project_analysis_data ON projects USING GIN(analysis_data);
CREATE INDEX idx_user_analytics_event_data ON user_analytics_enhanced USING GIN(event_data);

-- Array searches
CREATE INDEX idx_user_profiles_tags ON user_profiles USING GIN(tags);
CREATE INDEX idx_user_gamification_achievements ON user_gamification USING GIN(achievements);
```

---

## Constraints

### Primary Key Constraints
All tables use UUID primary keys with `gen_random_uuid()` default.

### Foreign Key Constraints
**Note:** No explicit foreign keys to `auth.users` (Supabase managed schema).

```sql
-- Project relationships
ALTER TABLE project_budget_items ADD CONSTRAINT fk_budget_project 
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE;

ALTER TABLE project_schedule_tasks ADD CONSTRAINT fk_schedule_project 
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE;

-- CRM relationships
ALTER TABLE crm_projects ADD CONSTRAINT fk_crm_project_client 
  FOREIGN KEY (client_id) REFERENCES crm_clients(id) ON DELETE CASCADE;

-- AI relationships
ALTER TABLE ai_messages ADD CONSTRAINT fk_ai_message_conversation 
  FOREIGN KEY (conversation_id) REFERENCES ai_conversations(id) ON DELETE CASCADE;
```

### Check Constraints

```sql
-- Validation constraints
ALTER TABLE user_gamification ADD CONSTRAINT chk_total_points_positive 
  CHECK (total_points >= 0);

ALTER TABLE user_gamification ADD CONSTRAINT chk_current_level_positive 
  CHECK (current_level >= 1);

ALTER TABLE project_budget_items ADD CONSTRAINT chk_quantity_positive 
  CHECK (quantity >= 0);

ALTER TABLE project_budget_items ADD CONSTRAINT chk_unit_value_positive 
  CHECK (unit_value >= 0);

-- Date validations (using triggers, not check constraints)
-- Note: Date validations are handled by triggers to avoid immutability issues
```

### Unique Constraints

```sql
-- User uniqueness
ALTER TABLE user_profiles ADD CONSTRAINT uniq_user_profiles_user_id 
  UNIQUE (user_id);

ALTER TABLE user_plans ADD CONSTRAINT uniq_user_plans_user_id 
  UNIQUE (user_id);

-- Business logic uniqueness
ALTER TABLE achievements ADD CONSTRAINT uniq_achievements_code 
  UNIQUE (code);

ALTER TABLE email_templates ADD CONSTRAINT uniq_email_templates_key 
  UNIQUE (template_key);

-- Composite uniqueness
ALTER TABLE ai_message_usage ADD CONSTRAINT uniq_ai_usage_user_period 
  UNIQUE (user_id, period_ym);
```

---

## Security (Row Level Security)

### RLS Status
**All tables have RLS enabled** with specific policies per table.

### Common RLS Patterns

#### 1. User Data Isolation
```sql
-- Users can only access their own data
CREATE POLICY "Users own data" ON table_name
  FOR ALL USING (auth.uid() = user_id);
```

#### 2. Admin Access
```sql
-- Admins can access all data
CREATE POLICY "Admin access" ON table_name
  FOR ALL USING (is_admin_user());
```

#### 3. Project-Based Access
```sql
-- Users can access data related to their projects
CREATE POLICY "Project access" ON table_name
  FOR ALL USING (EXISTS (
    SELECT 1 FROM projects 
    WHERE projects.id = table_name.project_id 
    AND projects.user_id = auth.uid()
  ));
```

#### 4. Public Read Access
```sql
-- Some data is publicly readable
CREATE POLICY "Public read" ON table_name
  FOR SELECT USING (true);
```

### Security Functions

```sql
-- Check if current user is admin
CREATE FUNCTION is_admin_user() RETURNS boolean AS $$
  SELECT EXISTS (
    SELECT 1 FROM admin_permissions 
    WHERE user_id = auth.uid() 
    AND active = true 
    AND role = 'super_admin'
  ) OR is_superuser();
$$ LANGUAGE SQL SECURITY DEFINER STABLE;

-- Check if current user is superuser
CREATE FUNCTION is_superuser() RETURNS boolean AS $$
  SELECT EXISTS (
    SELECT 1 FROM pg_roles 
    WHERE rolname = current_user AND rolsuper = true
  );
$$ LANGUAGE SQL SECURITY DEFINER STABLE;
```

---

## Performance Considerations

### Query Optimization

1. **User-scoped queries** - All user data queries use `user_id` indexes
2. **Time-range queries** - Timestamp columns are indexed for efficient sorting
3. **Status filtering** - Enum and text status fields are indexed
4. **JSONB queries** - GIN indexes on JSONB columns for complex searches

### Scaling Strategies

1. **Partitioning candidates:**
   - `user_analytics_enhanced` (by date)
   - `ai_messages` (by conversation_id)
   - `email_logs` (by date)

2. **Archive candidates:**
   - `user_login_history` (>1 year)
   - `admin_audit_logs` (>2 years)
   - `email_logs` (>6 months)

3. **Read replicas for:**
   - Analytics queries
   - Reporting dashboards
   - Admin panels

---

## Backup and Recovery

### Critical Tables (Priority 1)
- `projects` - Core business data
- `user_profiles` - User information
- `project_budget_items` - Financial data
- `project_schedule_tasks` - Project timelines

### Important Tables (Priority 2)
- `ai_conversations` - AI interactions
- `crm_clients` - Customer data
- `crm_projects` - CRM data
- `user_subscriptions` - Billing data

### Restorable Tables (Priority 3)
- `user_analytics_enhanced` - Analytics (regenerable)
- `email_logs` - Email history
- `user_login_history` - Login tracking

---

## Data Retention Policies

| Table | Retention | Policy |
|-------|-----------|--------|
| `user_analytics_enhanced` | 2 years | Auto-archive monthly |
| `user_login_history` | 1 year | Auto-delete monthly |
| `email_logs` | 6 months | Auto-archive monthly |
| `admin_audit_logs` | 7 years | Legal requirement |
| `ai_messages` | Indefinite | User-controlled deletion |
| `projects` | Indefinite | User-controlled deletion |

---

## Monitoring and Alerting

### Key Metrics to Monitor

1. **Table sizes** - Rapid growth detection
2. **Query performance** - Slow query identification
3. **Index usage** - Unused index cleanup
4. **RLS policy violations** - Security monitoring
5. **Foreign key violations** - Data integrity
6. **Connection counts** - Performance monitoring

### Alert Thresholds

- Table growth >50% month-over-month
- Query duration >5 seconds
- Failed RLS checks >10/hour
- Database connections >80% of limit

---

## Database Functions

See the comprehensive list of 40+ database functions in the Supabase configuration, including:

- **User management:** `handle_new_user_profile()`, `sync_user_metadata()`
- **Gamification:** `award_points()`, `calculate_level_from_points()`
- **Admin operations:** `admin_update_user_complete()`, `log_admin_security_action()`
- **Analytics:** `calculate_user_engagement()`, `get_user_engagement()`
- **Geolocation:** `validate_geolocation_quality()`, `update_login_location_by_ip()`
- **Security:** `is_admin_user()`, `is_superuser()`

---

## Change Log

| Date | Change | Impact |
|------|--------|--------|
| 2025-01-25 | Added observability tables | New monitoring capabilities |
| 2025-01-20 | Enhanced CRM functionality | Improved client management |
| 2025-01-15 | Gamification system | User engagement features |
| 2025-01-10 | Analytics enhancement | Better user tracking |
| 2025-01-05 | Security improvements | Enhanced RLS policies |

---

**Document Version:** 1.0  
**Last Updated:** 2025-08-25  
**Next Review:** 2025-09-25