# ADR-002: PolÃ­tica de Contratos Congelados

**Status**: Aceito  
**Data**: 2025-08-25  
**Decisores**: MadenAI Architecture Team

## ğŸ“‹ Contexto

Durante o desenvolvimento do MadenAI, identificamos quebras frequentes em APIs e funcionalidades devido a:

- **MudanÃ§as nÃ£o documentadas** em assinaturas de funÃ§Ãµes
- **AlteraÃ§Ãµes de schema** sem versionamento adequado
- **Quebras em integraÃ§Ãµes** com N8N e Supabase
- **InconsistÃªncia** entre documentaÃ§Ã£o e implementaÃ§Ã£o
- **Dificuldade de debugging** quando APIs mudam silenciosamente

### Problemas EspecÃ­ficos

1. **APIs Supabase**: Edge Functions mudando assinaturas
2. **N8N Webhooks**: URLs e payloads alterados sem aviso
3. **Exports/Imports**: FunÃ§Ãµes pÃºblicas modificadas breaking consuming code
4. **Database Schema**: MudanÃ§as que quebram queries existentes
5. **Frontend/Backend**: Contratos implÃ­citos nÃ£o documentados

## âš–ï¸ DecisÃ£o

Implementamos **polÃ­tica de contratos congelados** com validaÃ§Ã£o automÃ¡tica:

### ğŸ“‹ DefiniÃ§Ã£o de Contratos

1. **OpenAPI Snapshots**:
   - Edge Functions documentadas em OpenAPI 3.0
   - Snapshots salvos em `/contracts/api/`
   - ValidaÃ§Ã£o automÃ¡tica em CI/CD

2. **Database Schema Contracts**:
   - Schema atual exportado em `/contracts/db/`
   - Views e functions documentadas
   - Migration compatibility checks

3. **Public API Surfaces**:
   - FunÃ§Ãµes exportadas mapeadas em `/contracts/exports/`
   - Type signatures preservadas
   - Breaking changes detectadas

4. **Integration Contracts**:
   - N8N webhook schemas em `/contracts/n8n/`
   - Supabase RPC signatures em `/contracts/supabase/`
   - External API dependencies mapeadas

### ğŸ§ª Smoke Tests como GuardiÃµes

Smoke tests em `/contracts/tests/smoke/` validam:

- **Importabilidade** de mÃ³dulos pÃºblicos
- **Disponibilidade** de endpoints crÃ­ticos
- **Compatibilidade** de responses bÃ¡sicos
- **Integridade** de contratos principais

### ğŸ“¸ Snapshot Strategy

```bash
# Antes de mudanÃ§as
npm run contracts:snapshot

# ApÃ³s mudanÃ§as
npm run contracts:validate

# Se breaking changes sÃ£o intencionais
npm run contracts:update
```

## âœ… ConsequÃªncias

### Positivas

1. **Estabilidade**: MudanÃ§as breaking sÃ£o detectadas previamente
2. **Confiabilidade**: IntegraÃ§Ãµes nÃ£o quebram silenciosamente
3. **DocumentaÃ§Ã£o**: Contratos sempre atualizados
4. **Debugging**: FÃ¡cil identificar quando/o que mudou
5. **Versionamento**: MudanÃ§as controladas e comunicadas

### Negativas

1. **Overhead**: ManutenÃ§Ã£o adicional de snapshots
2. **Rigidez**: MudanÃ§as legÃ­timas podem ser bloqueadas
3. **False Positives**: Smoke tests podem falhar por razÃµes benignas
4. **Complexidade**: Pipeline mais complexo

### MitigaÃ§Ãµes

- **Update processo claro**: Como fazer mudanÃ§as breaking intencionais
- **Granularidade**: Diferentes nÃ­veis de criticidade
- **Bypass temporÃ¡rio**: Para emergÃªncias e hotfixes
- **DocumentaÃ§Ã£o**: Processo bem documentado para time

## ğŸ”§ ImplementaÃ§Ã£o

### Estrutura de Contratos

```
contracts/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ auth.openapi.yaml
â”‚   â”œâ”€â”€ projects.openapi.yaml
â”‚   â””â”€â”€ ai.openapi.yaml
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ schema.sql
â”‚   â”œâ”€â”€ functions.sql
â”‚   â””â”€â”€ views.sql
â”œâ”€â”€ exports/
â”‚   â”œâ”€â”€ components.d.ts
â”‚   â”œâ”€â”€ hooks.d.ts
â”‚   â””â”€â”€ utils.d.ts
â”œâ”€â”€ n8n/
â”‚   â”œâ”€â”€ upload-webhook.json
â”‚   â”œâ”€â”€ analysis-webhook.json
â”‚   â””â”€â”€ ai-webhook.json
â””â”€â”€ tests/smoke/
    â”œâ”€â”€ imports.test.js
    â”œâ”€â”€ routes.test.js
    â””â”€â”€ run-all.js
```

### Processo de MudanÃ§a

1. **Proposta**: RFC para mudanÃ§as breaking
2. **Review**: Architecture team aprova mudanÃ§a
3. **Snapshot**: Criar novo snapshot antes da mudanÃ§a
4. **Implement**: Implementar mudanÃ§a
5. **Validate**: Rodar smoke tests
6. **Update**: Atualizar contratos se necessÃ¡rio
7. **Deploy**: Deploy com nova versÃ£o de contrato

### NÃ­veis de Criticidade

- **CRITICAL**: APIs pÃºblicas, database schema
- **HIGH**: Integration endpoints, major exports
- **MEDIUM**: Internal APIs, utility functions
- **LOW**: UI components, helper functions

## ğŸ“Š MÃ©tricas de Sucesso

- Zero breaking changes nÃ£o detectadas em produÃ§Ã£o
- 95% de smoke tests passando consistentemente
- Tempo mÃ©dio de detecÃ§Ã£o de quebras < 5 minutos
- ReduÃ§Ã£o de 80% em bugs relacionados a mudanÃ§as de API

## ğŸš¨ Processo de EmergÃªncia

Para situaÃ§Ãµes crÃ­ticas onde mudanÃ§as breaking sÃ£o necessÃ¡rias:

1. **Hotfix Exception**: Bypass temporÃ¡rio com aprovaÃ§Ã£o
2. **Immediate Notification**: Comunicar time imediatamente
3. **Fast Track**: Atualizar contratos em 24h
4. **Post-mortem**: AnÃ¡lise de como prevenir no futuro

---

**RevisÃ£o**: Trimestral  
**ResponsÃ¡vel**: Architecture Team + DevOps