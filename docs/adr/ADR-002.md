# ADR-002: Política de Contratos Congelados

**Status**: Aceito  
**Data**: 2025-08-25  
**Decisores**: MadenAI Architecture Team

## 📋 Contexto

Durante o desenvolvimento do MadenAI, identificamos quebras frequentes em APIs e funcionalidades devido a:

- **Mudanças não documentadas** em assinaturas de funções
- **Alterações de schema** sem versionamento adequado
- **Quebras em integrações** com N8N e Supabase
- **Inconsistência** entre documentação e implementação
- **Dificuldade de debugging** quando APIs mudam silenciosamente

### Problemas Específicos

1. **APIs Supabase**: Edge Functions mudando assinaturas
2. **N8N Webhooks**: URLs e payloads alterados sem aviso
3. **Exports/Imports**: Funções públicas modificadas breaking consuming code
4. **Database Schema**: Mudanças que quebram queries existentes
5. **Frontend/Backend**: Contratos implícitos não documentados

## ⚖️ Decisão

Implementamos **política de contratos congelados** com validação automática:

### 📋 Definição de Contratos

1. **OpenAPI Snapshots**:
   - Edge Functions documentadas em OpenAPI 3.0
   - Snapshots salvos em `/contracts/api/`
   - Validação automática em CI/CD

2. **Database Schema Contracts**:
   - Schema atual exportado em `/contracts/db/`
   - Views e functions documentadas
   - Migration compatibility checks

3. **Public API Surfaces**:
   - Funções exportadas mapeadas em `/contracts/exports/`
   - Type signatures preservadas
   - Breaking changes detectadas

4. **Integration Contracts**:
   - N8N webhook schemas em `/contracts/n8n/`
   - Supabase RPC signatures em `/contracts/supabase/`
   - External API dependencies mapeadas

### 🧪 Smoke Tests como Guardiões

Smoke tests em `/contracts/tests/smoke/` validam:

- **Importabilidade** de módulos públicos
- **Disponibilidade** de endpoints críticos
- **Compatibilidade** de responses básicos
- **Integridade** de contratos principais

### 📸 Snapshot Strategy

```bash
# Antes de mudanças
npm run contracts:snapshot

# Após mudanças
npm run contracts:validate

# Se breaking changes são intencionais
npm run contracts:update
```

## ✅ Consequências

### Positivas

1. **Estabilidade**: Mudanças breaking são detectadas previamente
2. **Confiabilidade**: Integrações não quebram silenciosamente
3. **Documentação**: Contratos sempre atualizados
4. **Debugging**: Fácil identificar quando/o que mudou
5. **Versionamento**: Mudanças controladas e comunicadas

### Negativas

1. **Overhead**: Manutenção adicional de snapshots
2. **Rigidez**: Mudanças legítimas podem ser bloqueadas
3. **False Positives**: Smoke tests podem falhar por razões benignas
4. **Complexidade**: Pipeline mais complexo

### Mitigações

- **Update processo claro**: Como fazer mudanças breaking intencionais
- **Granularidade**: Diferentes níveis de criticidade
- **Bypass temporário**: Para emergências e hotfixes
- **Documentação**: Processo bem documentado para time

## 🔧 Implementação

### Estrutura de Contratos

```
contracts/
├── api/
│   ├── auth.openapi.yaml
│   ├── projects.openapi.yaml
│   └── ai.openapi.yaml
├── db/
│   ├── schema.sql
│   ├── functions.sql
│   └── views.sql
├── exports/
│   ├── components.d.ts
│   ├── hooks.d.ts
│   └── utils.d.ts
├── n8n/
│   ├── upload-webhook.json
│   ├── analysis-webhook.json
│   └── ai-webhook.json
└── tests/smoke/
    ├── imports.test.js
    ├── routes.test.js
    └── run-all.js
```

### Processo de Mudança

1. **Proposta**: RFC para mudanças breaking
2. **Review**: Architecture team aprova mudança
3. **Snapshot**: Criar novo snapshot antes da mudança
4. **Implement**: Implementar mudança
5. **Validate**: Rodar smoke tests
6. **Update**: Atualizar contratos se necessário
7. **Deploy**: Deploy com nova versão de contrato

### Níveis de Criticidade

- **CRITICAL**: APIs públicas, database schema
- **HIGH**: Integration endpoints, major exports
- **MEDIUM**: Internal APIs, utility functions
- **LOW**: UI components, helper functions

## 📊 Métricas de Sucesso

- Zero breaking changes não detectadas em produção
- 95% de smoke tests passando consistentemente
- Tempo médio de detecção de quebras < 5 minutos
- Redução de 80% em bugs relacionados a mudanças de API

## 🚨 Processo de Emergência

Para situações críticas onde mudanças breaking são necessárias:

1. **Hotfix Exception**: Bypass temporário com aprovação
2. **Immediate Notification**: Comunicar time imediatamente
3. **Fast Track**: Atualizar contratos em 24h
4. **Post-mortem**: Análise de como prevenir no futuro

---

**Revisão**: Trimestral  
**Responsável**: Architecture Team + DevOps