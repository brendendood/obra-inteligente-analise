
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import { 
  ChevronRight, 
  ChevronLeft, 
  Check, 
  Play,
  Upload,
  Calculator,
  Calendar,
  Bot,
  FileText,
  Home,
  Sparkles
} from 'lucide-react';
import { useAuth } from '@/hooks/useAuth';

const OnboardingStep = ({ 
  step, 
  isActive, 
  isCompleted, 
  onNext, 
  onPrev, 
  onSkip 
}: {
  step: any;
  isActive: boolean;
  isCompleted: boolean;
  onNext: () => void;
  onPrev: () => void;
  onSkip: () => void;
}) => {
  if (!isActive) return null;

  return (
    <div className="animate-fade-in">
      <Card className="border-2 border-blue-200 bg-gradient-to-br from-blue-50 to-indigo-50">
        <CardHeader className="text-center pb-4">
          <div className="flex justify-center mb-4">
            <div className="p-4 bg-blue-100 rounded-full">
              <step.icon className="h-8 w-8 text-blue-600" />
            </div>
          </div>
          <CardTitle className="text-2xl text-blue-900 mb-2">
            {step.title}
          </CardTitle>
          <p className="text-blue-700 text-lg">
            {step.subtitle}
          </p>
        </CardHeader>
        
        <CardContent className="space-y-6">
          <div className="bg-white rounded-lg p-6 border border-blue-100">
            <div className="space-y-4">
              {step.content.map((item: any, index: number) => (
                <div key={index} className="flex items-start space-x-3">
                  <div className="flex-shrink-0 mt-1">
                    <div className="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center">
                      <span className="text-white text-sm font-medium">
                        {index + 1}
                      </span>
                    </div>
                  </div>
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-1">
                      {item.title}
                    </h4>
                    <p className="text-gray-600 text-sm leading-relaxed">
                      {item.description}
                    </p>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {step.tip && (
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <div className="flex items-start space-x-2">
                <Sparkles className="h-5 w-5 text-yellow-600 flex-shrink-0 mt-0.5" />
                <div>
                  <h5 className="font-medium text-yellow-800 mb-1">üí° Dica Importante</h5>
                  <p className="text-yellow-700 text-sm">{step.tip}</p>
                </div>
              </div>
            </div>
          )}

          <div className="flex justify-between items-center pt-4">
            <Button 
              variant="outline" 
              onClick={onPrev}
              disabled={step.id === 1}
              className="flex items-center space-x-2"
            >
              <ChevronLeft className="h-4 w-4" />
              <span>Anterior</span>
            </Button>

            <Button 
              variant="ghost" 
              onClick={onSkip}
              className="text-gray-500 hover:text-gray-700"
            >
              Pular Tutorial
            </Button>

            <Button 
              onClick={onNext}
              className="bg-blue-600 hover:bg-blue-700 flex items-center space-x-2"
            >
              <span>{step.id === 6 ? 'Finalizar' : 'Pr√≥ximo'}</span>
              <ChevronRight className="h-4 w-4" />
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

const Onboarding = () => {
  const navigate = useNavigate();
  const { user } = useAuth();
  const [currentStep, setCurrentStep] = useState(1);
  const [completedSteps, setCompletedSteps] = useState<number[]>([]);

  const userName = user?.user_metadata?.full_name || user?.email?.split('@')[0] || 'Usu√°rio';

  const onboardingSteps = [
    {
      id: 1,
      title: `Bem-vindo ao MadenAI, ${userName}! üéâ`,
      subtitle: "Sua plataforma de gest√£o inteligente de obras",
      icon: Home,
      content: [
        {
          title: "O que √© o MadenAI?",
          description: "Uma plataforma completa que usa intelig√™ncia artificial para otimizar o gerenciamento de projetos de constru√ß√£o, desde o or√ßamento at√© o cronograma."
        },
        {
          title: "Como funciona?",
          description: "Voc√™ faz upload dos seus projetos (plantas, documentos) e nossa IA analisa tudo automaticamente, gerando or√ßamentos, cronogramas e insights valiosos."
        },
        {
          title: "Por que usar?",
          description: "Economize tempo, reduza erros, tome decis√µes mais inteligentes e tenha controle total dos seus projetos em um s√≥ lugar."
        }
      ],
      tip: "Este tutorial r√°pido vai te ensinar tudo que voc√™ precisa saber para come√ßar!"
    },
    {
      id: 2,
      title: "Criando seu Primeiro Projeto üìÅ",
      subtitle: "Aprenda a fazer upload e organizar seus projetos",
      icon: Upload,
      content: [
        {
          title: "Acesse a √°rea de Upload",
          description: "Clique no bot√£o '+ Novo Projeto' no painel principal ou v√° direto para a p√°gina de Upload no menu lateral."
        },
        {
          title: "Fa√ßa upload dos arquivos",
          description: "Arraste plantas, documentos, planilhas ou qualquer arquivo relacionado ao seu projeto. Formatos aceitos: PDF, JPG, PNG, XLS, DWG."
        },
        {
          title: "Nomeie seu projeto",
          description: "D√™ um nome claro e descritivo para facilitar a identifica√ß√£o posterior."
        },
        {
          title: "Aguarde a an√°lise",
          description: "Nossa IA vai processar todos os arquivos e extrair informa√ß√µes importantes automaticamente."
        }
      ],
      tip: "Quanto mais detalhados forem seus arquivos, mais precisa ser√° a an√°lise da IA!"
    },
    {
      id: 3,
      title: "Or√ßamento Inteligente üí∞",
      subtitle: "Gera√ß√£o autom√°tica de or√ßamentos detalhados",
      icon: Calculator,
      content: [
        {
          title: "Or√ßamento autom√°tico",
          description: "Ap√≥s a an√°lise, acesse a aba 'Or√ßamento' do seu projeto para ver a planilha gerada automaticamente com base nas plantas e especifica√ß√µes."
        },
        {
          title: "Editar itens",
          description: "Voc√™ pode editar pre√ßos, adicionar novos itens, ajustar quantidades e personalizar completamente o or√ßamento."
        },
        {
          title: "Exportar relat√≥rios",
          description: "Exporte o or√ßamento em Excel ou PDF para apresentar aos clientes ou usar em outras ferramentas."
        },
        {
          title: "Hist√≥rico de vers√µes",
          description: "Mantenha um hist√≥rico de todas as altera√ß√µes feitas no or√ßamento para controle total."
        }
      ],
      tip: "Use a fun√ß√£o de comparar vers√µes para mostrar aos clientes como o projeto evoluiu!"
    },
    {
      id: 4,
      title: "Cronograma Inteligente üìÖ",
      subtitle: "Planejamento temporal otimizado pela IA",
      icon: Calendar,
      content: [
        {
          title: "Cronograma autom√°tico",
          description: "A IA cria um cronograma f√≠sico-financeiro baseado no tipo de obra, or√ßamento e prazos t√≠picos do mercado."
        },
        {
          title: "Arrastar e reorganizar",
          description: "Reorganize as etapas arrastando os cart√µes. O sistema recalcula automaticamente as depend√™ncias e datas."
        },
        {
          title: "Acompanhar progresso",
          description: "Marque etapas como conclu√≠das e veja o progresso geral da obra em tempo real."
        },
        {
          title: "Alertas inteligentes",
          description: "Receba notifica√ß√µes sobre atrasos, depend√™ncias cr√≠ticas e marcos importantes."
        }
      ],
      tip: "Mantenha o cronograma sempre atualizado para ter insights precisos sobre prazos!"
    },
    {
      id: 5,
      title: "Assistente IA ü§ñ",
      subtitle: "Seu consultor especializado em constru√ß√£o",
      icon: Bot,
      content: [
        {
          title: "Chat inteligente",
          description: "Converse com nossa IA especializada em constru√ß√£o. Fa√ßa perguntas sobre seu projeto, pe√ßa sugest√µes de otimiza√ß√£o ou tire d√∫vidas t√©cnicas."
        },
        {
          title: "An√°lises personalizadas",
          description: "Pe√ßa an√°lises espec√≠ficas: 'Como posso reduzir custos?', 'Quais s√£o os riscos deste cronograma?', 'Sugest√µes de materiais alternativos?'"
        },
        {
          title: "Relat√≥rios sob demanda",
          description: "Solicite relat√≥rios customizados, compara√ß√µes de cen√°rios e simula√ß√µes de mudan√ßas no projeto."
        },
        {
          title: "Conhecimento atualizado",
          description: "A IA tem acesso √†s melhores pr√°ticas do mercado, pre√ßos atualizados e normas t√©cnicas vigentes."
        }
      ],
      tip: "Seja espec√≠fico nas suas perguntas para obter respostas mais precisas e √∫teis!"
    },
    {
      id: 6,
      title: "Documentos e Organiza√ß√£o üìã",
      subtitle: "Mantenha tudo organizado e acess√≠vel",
      icon: FileText,
      content: [
        {
          title: "Central de documentos",
          description: "Todos os arquivos do projeto ficam organizados na aba 'Documentos', categorizados automaticamente por tipo."
        },
        {
          title: "Busca inteligente",
          description: "Encontre rapidamente qualquer documento usando palavras-chave. A IA indexa o conte√∫do dos arquivos para busca avan√ßada."
        },
        {
          title: "Versionamento",
          description: "Mantenha diferentes vers√µes dos documentos com hist√≥rico completo de altera√ß√µes e coment√°rios."
        },
        {
          title: "Compartilhamento",
          description: "Gere links seguros para compartilhar documentos espec√≠ficos com clientes, fornecedores ou equipe."
        }
      ],
      tip: "Organize bem seus documentos desde o in√≠cio - isso facilitar√° muito o trabalho futuro!"
    }
  ];

  const handleNext = () => {
    if (currentStep < onboardingSteps.length) {
      setCompletedSteps(prev => [...prev, currentStep]);
      setCurrentStep(prev => prev + 1);
    } else {
      handleComplete();
    }
  };

  const handlePrev = () => {
    if (currentStep > 1) {
      setCurrentStep(prev => prev - 1);
    }
  };

  const handleSkip = () => {
    navigate('/painel');
  };

  const handleComplete = () => {
    // Marcar onboarding como conclu√≠do
    localStorage.setItem('maden-onboarding-completed', 'true');
    navigate('/painel');
  };

  const progress = (completedSteps.length / onboardingSteps.length) * 100;

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50">
      <div className="container max-w-4xl mx-auto px-4 py-8">
        {/* Header */}
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-gray-900 mb-4">
            Tutorial MadenAI
          </h1>
          <p className="text-xl text-gray-600 mb-6">
            Aprenda a usar todas as funcionalidades em poucos minutos
          </p>
          
          {/* Progress Bar */}
          <div className="max-w-md mx-auto">
            <div className="flex justify-between items-center mb-2">
              <span className="text-sm text-gray-500">Progresso</span>
              <span className="text-sm font-medium text-gray-700">
                {currentStep} de {onboardingSteps.length}
              </span>
            </div>
            <Progress value={(currentStep / onboardingSteps.length) * 100} className="h-2" />
          </div>
        </div>

        {/* Steps Navigation */}
        <div className="flex justify-center mb-8">
          <div className="flex space-x-2 overflow-x-auto pb-2">
            {onboardingSteps.map((step) => (
              <Badge
                key={step.id}
                variant={currentStep === step.id ? "default" : completedSteps.includes(step.id) ? "secondary" : "outline"}
                className={`flex items-center space-x-1 px-3 py-1 whitespace-nowrap ${
                  currentStep === step.id ? 'bg-blue-600' : 
                  completedSteps.includes(step.id) ? 'bg-green-100 text-green-800' : ''
                }`}
              >
                {completedSteps.includes(step.id) ? (
                  <Check className="h-3 w-3" />
                ) : (
                  <step.icon className="h-3 w-3" />
                )}
                <span className="hidden sm:inline">Passo {step.id}</span>
                <span className="sm:hidden">{step.id}</span>
              </Badge>
            ))}
          </div>
        </div>

        {/* Current Step */}
        <div className="max-w-3xl mx-auto">
          {onboardingSteps.map((step) => (
            <OnboardingStep
              key={step.id}
              step={step}
              isActive={currentStep === step.id}
              isCompleted={completedSteps.includes(step.id)}
              onNext={handleNext}
              onPrev={handlePrev}
              onSkip={handleSkip}
            />
          ))}
        </div>
      </div>
    </div>
  );
};

export default Onboarding;
